<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Breath Timer (Fully Editable Steps)</title>
  <style>
    :root{
      --bg:#0b0f17;
      --card:#121a2a;
      --text:#e8eefc;
      --muted:#a8b3cc;
      --line:#22314f;
      --accent:#6aa9ff;
      --good:#7cffc1;
      --warn:#ffcc66;
      --danger:#ff6a6a;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --r:18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background: radial-gradient(1200px 800px at 20% -10%, rgba(106,169,255,.25), transparent 60%),
                  radial-gradient(900px 700px at 120% 10%, rgba(124,255,193,.18), transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    .wrap{max-width:1050px;margin:0 auto;padding:18px 14px 40px}
    header{display:flex;gap:12px;align-items:flex-end;justify-content:space-between;flex-wrap:wrap;margin-bottom:14px}
    h1{margin:0;font-size:22px;letter-spacing:.2px}
    .sub{margin:2px 0 0;color:var(--muted);font-size:13px}

    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:920px){.grid{grid-template-columns:1.05fr .95fr}}

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.08);
      border-radius:var(--r);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .hd{
      padding:14px 14px 10px;
      display:flex;justify-content:space-between;align-items:center;gap:10px;
      border-bottom:1px solid rgba(255,255,255,.06);
      background:rgba(0,0,0,.12);
    }
    .hd h2{margin:0;font-size:14px;letter-spacing:.2px}
    .bd{padding:14px}

    .pill{
      display:inline-flex;gap:8px;align-items:center;
      padding:8px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.08);
      background:rgba(255,255,255,.03);
      font-size:12px;color:var(--muted);
      white-space:nowrap;
    }
    .pill b{color:var(--text)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .sep{height:10px}

    .big{
      font-variant-numeric: tabular-nums;
      font-size:54px;line-height:1;margin:0;
      letter-spacing:.5px;
    }
    .phase{margin-top:6px;color:var(--muted);font-size:15px}

    button{
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      color:var(--text);
      padding:12px 14px;border-radius:14px;
      cursor:pointer;font-weight:800;letter-spacing:.2px;
      user-select:none;
      transition: transform .04s ease, background .15s ease, border-color .15s ease, opacity .15s ease;
    }
    button:active{transform:scale(.99)}
    button.primary{background:rgba(106,169,255,.22);border-color:rgba(106,169,255,.40)}
    button.good{background:rgba(124,255,193,.18);border-color:rgba(124,255,193,.35)}
    button.warn{background:rgba(255,204,102,.15);border-color:rgba(255,204,102,.35)}
    button.danger{background:rgba(255,106,106,.16);border-color:rgba(255,106,106,.35)}
    button:disabled{opacity:.45;cursor:not-allowed}
    .tiny{padding:9px 10px;border-radius:12px;font-size:12px;font-weight:900}

    .control{
      display:grid;
      grid-template-columns:1fr auto;
      gap:10px;align-items:center;
      padding:10px 12px;border-radius:14px;
      background:rgba(255,255,255,.03);
      border:1px solid rgba(255,255,255,.08);
    }
    .control label{font-weight:800;font-size:13px}
    .muted{color:var(--muted);font-size:12px;line-height:1.35}
    .val{font-variant-numeric:tabular-nums;font-weight:900;min-width:110px;text-align:right}
    input[type="range"]{width:100%}
    input[type="checkbox"]{transform:scale(1.15)}

    textarea{
      width:100%;min-height:170px;padding:12px;border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.18);color:var(--text);
      font-family: ui-monospace, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size:12px;
    }

    .list{display:flex;flex-direction:column;gap:8px}
    .step{
      display:grid;
      grid-template-columns: 1fr 120px 120px auto;
      gap:8px;
      padding:10px 10px;border-radius:14px;
      background:rgba(255,255,255,.03);
      border:1px solid rgba(255,255,255,.08);
      align-items:center;
    }
    @media(max-width:650px){
      .step{grid-template-columns:1fr 120px;grid-auto-rows:auto}
      .step .actions{grid-column:1/-1;justify-content:flex-end}
      .step .type{grid-column:1/2}
      .step .sec{grid-column:2/3}
    }
    .step input[type="text"], .step input[type="number"], .step select{
      width:100%;
      padding:10px 10px;border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.18);
      color:var(--text);
      font-weight:800;
    }
    .step input[type="number"]{font-variant-numeric:tabular-nums}
    .actions{display:flex;gap:8px;align-items:center;justify-content:flex-end}
    .badge{
      display:inline-flex;align-items:center;justify-content:center;
      width:28px;height:28px;border-radius:10px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.18);
      color:var(--muted);
      font-weight:900;
      font-variant-numeric:tabular-nums;
    }
    .hint{
      padding:10px 12px;border-radius:14px;
      background:rgba(106,169,255,.10);
      border:1px solid rgba(106,169,255,.22);
      color:var(--muted);
      font-size:12px;line-height:1.35;
    }
    .footer{
      margin-top:10px;color:var(--muted);font-size:12px;line-height:1.35
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Breath Timer</h1>
        <div class="sub">Edit every step (label + duration), then Start. Use Prev/Next to jump steps anytime.</div>
      </div>
    </header>

    <div class="grid">
      <!-- TIMER -->
      <div class="card">
        <div class="hd">
          <h2>Session</h2>
          <span class="pill"><span>Step</span> <b id="stepNum">0/0</b></span>
        </div>
        <div class="bd">
          <p class="big" id="timeLeft">00:00</p>
          <div class="phase" id="stepLabel">Ready</div>

          <div class="sep"></div>
          <div class="row">
            <span class="pill"><span>Total left</span> <b id="totalLeft">00:00</b></span>
            <span class="pill"><span>Elapsed</span> <b id="elapsed">00:00</b></span>
            <span class="pill"><span>Status</span> <b id="status">Stopped</b></span>
          </div>

          <div class="sep"></div>
          <div class="row">
            <span class="pill"><span>Mode</span> <b id="mode">Loop</b></span>
            <span class="pill"><span>Sound</span> <b id="soundState">Off</b></span>
            <span class="pill"><span>Voice</span> <b id="voiceState">Off</b></span>
          </div>

          <div class="sep"></div>
          <div class="row">
            <button class="primary" id="startBtn">Start</button>
            <button class="good" id="pauseBtn" disabled>Pause</button>
            <button class="good" id="resumeBtn" disabled>Resume</button>
            <button class="danger" id="stopBtn" disabled>Stop</button>
          <button class="warn" id="prevBtn" disabled>Previous</button>
          <button class="warn" id="nextBtn" disabled>Next</button>
          </div>

          <div class="sep"></div>
          <div class="row">
            <button class="tiny" id="restartStepBtn" disabled>Restart step</button>
          </div>

          <div class="footer">
            Safety: do this seated. Stop if dizzy/tingly/vision changes. No breath holds in water or while driving.
          </div>
        </div>
      </div>

      <!-- SETTINGS -->
      <div class="card">
        <div class="hd">
          <h2>Settings</h2>
          <span class="pill"><span>Saved</span> <b id="saved">Yes</b></span>
        </div>
        <div class="bd">
          <div class="control">
            <div>
              <label>Mode</label>
              <div class="muted">Loop repeats your step list until total minutes. Run once stops at end of list.</div>
            </div>
            <div class="val">
              <label style="display:flex;gap:10px;align-items:center;justify-content:flex-end">
                <input type="checkbox" id="loopMode" />
                <span style="font-weight:900">Loop</span>
              </label>
            </div>
          </div>

          <div class="sep"></div>

          <div class="control">
            <div>
              <label for="totalMin">Total duration (minutes)</label>
              <div class="muted">Only used in Loop mode.</div>
            </div>
            <div class="val" id="totalVal">8:00</div>
            <input id="totalMin" type="range" min="3" max="30" step="1" />
            <div></div>
          </div>

          <div class="sep"></div>

          <div class="control">
            <div>
              <label>Sound + voice</label>
              <div class="muted">Sound/voice work best after tapping Start/Resume (phone browser rule).</div>
            </div>
            <div class="val" style="display:flex;gap:14px;justify-content:flex-end;align-items:center">
              <label style="display:flex;gap:10px;align-items:center">
                <input type="checkbox" id="soundOn" />
                <span style="font-weight:900">Sound</span>
              </label>
              <label style="display:flex;gap:10px;align-items:center">
                <input type="checkbox" id="voiceOn" />
                <span style="font-weight:900">Voice</span>
              </label>
            </div>
          </div>

          <div class="sep"></div>

          <div class="control">
            <div>
              <label for="volume">Volume</label>
              <div class="muted">Only used if Sound is enabled.</div>
            </div>
            <div class="val" id="volVal">70%</div>
            <input id="volume" type="range" min="0" max="100" step="5" />
            <div></div>
          </div>

          <div class="sep"></div>

          <div class="row">
            <button class="tiny" id="exportBtn">Export routine JSON</button>
            <button class="tiny" id="importBtn">Import routine JSON</button>
            <button class="tiny" id="loadTendonBtn">Load Tendon Routine</button>
            <button class="tiny danger" id="resetBtn">Reset defaults</button>
          </div>

          <div class="sep"></div>
          <textarea id="jsonBox" spellcheck="false" placeholder="Routine JSON shows here. Paste JSON then tap Import."></textarea>

          <div class="sep"></div>
          <div class="hint">
            Keyboard shortcuts (desktop): <b>Space</b>=start/pause/resume • <b>N</b>=next • <b>P</b>=prev • <b>S</b>=stop
          </div>
        </div>
      </div>

      <!-- STEP EDITOR -->
      <div class="card" style="grid-column:1/-1">
        <div class="hd">
          <h2>Step Editor (label + duration + type)</h2>
          <span class="pill"><span>Steps</span> <b id="stepCount">0</b></span>
        </div>
        <div class="bd">
          <div class="row">
            <button class="tiny" id="addStepBtn">Add step</button>
            <button class="tiny" id="addHoldRestBtn">Add hold+rest pair</button>
          </div>

          <div class="sep"></div>
          <div class="list" id="steps"></div>

          <div class="sep"></div>
          <div class="hint">
            Tip: For CO₂ tolerance, a safe pattern is longer normal breathing early, then gradual reduction. Keep holds modest and stop if symptomatic.
          </div>
        </div>
      </div>

      <!-- LOG -->
      <div class="card" style="grid-column:1/-1">
        <div class="hd">
          <h2>Log</h2>
          <span class="pill"><span>Events</span> <b id="logCount">0</b></span>
        </div>
        <div class="bd">
          <div class="list" id="log"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    /***************
     * Helpers
     ***************/
    const $ = (id) => document.getElementById(id);
    const pad2 = (n) => String(n).padStart(2,'0');
    function fmtMMSS(sec){
      sec = Math.max(0, Math.floor(sec));
      const m = Math.floor(sec/60);
      const s = sec%60;
      return `${pad2(m)}:${pad2(s)}`;
    }
    function fmtMSS(sec){
      sec = Math.max(0, Math.floor(sec));
      const m = Math.floor(sec/60);
      const s = sec%60;
      return `${m}:${pad2(s)}`;
    }
    function clamp(x,min,max){ return Math.min(max, Math.max(min, x)); }

    /***************
     * Storage keys
     ***************/
    const KEY_SETTINGS = "breath_timer_settings_v1";
    const KEY_ROUTINE  = "breath_timer_routine_v1";
    const KEY_LOG      = "breath_timer_log_v1";

    /***************
     * Default routine
     ***************/
    function defaultRoutine(){
      // Safer CO2-style: 45s holds, long breathing early, gradual decrease
      return {
        name: "CO2 Safe 8m (45s hold, decreasing breathe)",
        loop: true,
        totalMin: 8,
        steps: [
          { label:"Breathe (Cycle 1)", sec:75, type:"rest" },
          { label:"Hold (45s)",        sec:45, type:"hold" },
          { label:"Breathe (Cycle 2)", sec:70, type:"rest" },
          { label:"Hold (45s)",        sec:45, type:"hold" },
          { label:"Breathe (Cycle 3)", sec:65, type:"rest" },
          { label:"Hold (45s)",        sec:45, type:"hold" },
          { label:"Breathe (Cycle 4)", sec:60, type:"rest" },
          { label:"Hold (45s)",        sec:45, type:"hold" },
          { label:"Breathe (Cycle 5)", sec:55, type:"rest" },
          { label:"Hold (45s)",        sec:45, type:"hold" },
          { label:"Breathe (Cycle 6)", sec:50, type:"rest" },
          { label:"Hold (45s)",        sec:45, type:"hold" }
        ]
      };
    }

    function tendonRoutineSteps(){
      // Conservative isometrics + mobility (roughly 10–12 minutes depending on pacing)
      return [
        { label:"Doorway pec stretch (30s)", sec:30, type:"rest" },
        { label:"Shoulder external rotation isometric (45s)", sec:45, type:"hold" },
        { label:"Straight-arm hang (30s)", sec:30, type:"hold" },
        { label:"Calf isometric (45s)", sec:45, type:"hold" },
        { label:"Couch stretch (30s) Left", sec:30, type:"rest" },
        { label:"Hamstring bridge iso (45s)", sec:45, type:"hold" },
        { label:"Doorway pec stretch (30s)", sec:30, type:"rest" },
        { label:"Shoulder external rotation isometric (45s)", sec:45, type:"hold" },
        { label:"Straight-arm hang (30s)", sec:30, type:"hold" },
        { label:"Calf isometric (45s)", sec:45, type:"hold" },
        { label:"Couch stretch (30s) Right", sec:30, type:"rest" },
        { label:"Hamstring bridge iso (45s)", sec:45, type:"hold" }
      ];
    }

    /***************
     * Settings state
     ***************/
    const settings = {
      loop: false,
      totalMin: 8,
      soundOn: true,
      voiceOn: true,
      volume: 50
    };

    /***************
     * Routine state
     ***************/
    let routine = defaultRoutine();
    let speechUnlocked = false;

    /***************
     * Timer runtime state
     ***************/
    const timer = {
      running:false,
      paused:false,
      stepIndex:0,
      remaining:0,
      elapsed:0,
      totalTarget:0, // only used in loop mode
      lastTick:0,
      accMs:0,
      audio:null
    };

    /***************
     * Audio + vibration
     ***************/
    function ensureAudio(){
      if (timer.audio) return timer.audio;
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const gain = ctx.createGain();
      gain.connect(ctx.destination);
      timer.audio = { ctx, gain };
      applyVolume();
      return timer.audio;
    }
    function applyVolume(){
      const vol = clamp(+settings.volume, 0, 100) / 100;
      $("volVal").textContent = `${Math.round(vol*100)}%`;
      if (timer.audio) timer.audio.gain.gain.value = vol * 0.35;
    }
    function beep(kind="phase"){
      if (!settings.soundOn) return;
      const { ctx, gain } = ensureAudio();
      if (ctx.state === "suspended") ctx.resume().catch(()=>{});
      const t0 = ctx.currentTime;
      const seq = (kind==="start") ? [0,.07,.14] : (kind==="end") ? [0,.12,.24,.36] : [0,.08];
      seq.forEach((dt, i) => {
        const o = ctx.createOscillator();
        o.type = "sine";
        o.frequency.value = (kind==="end") ? 880 : (kind==="start") ? 740 : 660;
        o.connect(gain);
        const on = t0 + dt;
        const off = on + 0.10;
        try{ o.start(on); o.stop(off); }catch(e){}
      });
    }

    /***************
     * Logging
     ***************/
    function addLog(title, detail=""){
      const el = document.createElement("div");
      el.className = "card";
      el.style.borderRadius = "14px";
      el.style.boxShadow = "none";
      el.style.background = "rgba(255,255,255,.03)";
      el.style.border = "1px solid rgba(255,255,255,.08)";

      const bd = document.createElement("div");
      bd.className = "bd";
      bd.style.padding = "10px 12px";

      const top = document.createElement("div");
      top.style.display="flex";
      top.style.justifyContent="space-between";
      top.style.gap="10px";

      const left = document.createElement("div");
      left.innerHTML = `<div style="font-weight:900">${escapeHtml(title)}</div>` +
                       (detail ? `<div class="muted" style="margin-top:2px">${escapeHtml(detail)}</div>` : "");

      const right = document.createElement("div");
      right.className="muted";
      const ts = new Date();
      right.textContent = ts.toLocaleTimeString([], {hour:"2-digit", minute:"2-digit", second:"2-digit"});

      top.appendChild(left);
      top.appendChild(right);
      bd.appendChild(top);
      el.appendChild(bd);

      const log = $("log");
      log.prepend(el);
      while(log.children.length > 60) log.removeChild(log.lastChild);
      $("logCount").textContent = String(log.children.length);

      saveLog();
    }
    function escapeHtml(s){
      return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
    }
    function saveLog(){
      const items = Array.from($("log").children).map(card => {
        const t = card.querySelector("div[style*='font-weight:900']")?.textContent || "";
        const d = card.querySelector(".muted")?.textContent || "";
        return { t, d };
      });
      localStorage.setItem(KEY_LOG, JSON.stringify(items));
    }
    function loadLog(){
      try{
        const raw = localStorage.getItem(KEY_LOG);
        if(!raw) return;
        const items = JSON.parse(raw);
        $("log").innerHTML = "";
        items.reverse().forEach(x => addLog(x.t, x.d));
      }catch(e){}
    }

    /***************
     * Save/load settings + routine
     ***************/
    function markSaved(saved){
      $("saved").textContent = saved ? "Yes" : "No";
    }

    function saveAll(){
      localStorage.setItem(KEY_SETTINGS, JSON.stringify(settings));
      localStorage.setItem(KEY_ROUTINE, JSON.stringify(routine));
      markSaved(true);
      syncUI();
    }

    function loadAll(){
      // settings
      try{
        const s = JSON.parse(localStorage.getItem(KEY_SETTINGS) || "null");
        if (s && typeof s === "object"){
          settings.loop = !!s.loop;
          settings.totalMin = clamp(+s.totalMin || 8, 3, 30);
        settings.soundOn = (s.soundOn === undefined) ? true : !!s.soundOn;
        settings.voiceOn = (s.voiceOn === undefined) ? true : !!s.voiceOn;
        settings.volume = clamp(+s.volume || 50, 0, 100);
        }
      }catch(e){}

      // routine
      try{
        const r = JSON.parse(localStorage.getItem(KEY_ROUTINE) || "null");
        if (r && typeof r === "object" && Array.isArray(r.steps)){
          routine = sanitizeRoutine(r);
        } else {
          routine = defaultRoutine();
        }
      }catch(e){
        routine = defaultRoutine();
      }

      // make routine reflect settings mode/duration by default (but user can override in JSON)
      routine.loop = settings.loop;
      routine.totalMin = settings.totalMin;
    }

    function sanitizeRoutine(r){
      const out = {
        name: String(r.name || "Routine"),
        loop: !!r.loop,
        totalMin: clamp(+r.totalMin || 8, 1, 300),
        steps: []
      };
      (r.steps || []).forEach(st => {
        const sec = clamp(Math.floor(+st.sec || 0), 1, 3600);
        if (!sec) return;
        out.steps.push({
          label: String(st.label || "Step"),
          sec,
          type: (st.type === "hold" || st.type === "rest" || st.type === "custom") ? st.type : "custom"
        });
      });
      if (out.steps.length === 0){
        out.steps = defaultRoutine().steps;
      }
      return out;
    }

    /***************
     * Step editor rendering
     ***************/
    function renderSteps(){
      const box = $("steps");
      box.innerHTML = "";
      $("stepCount").textContent = String(routine.steps.length);

      routine.steps.forEach((st, idx) => {
        const row = document.createElement("div");
        row.className = "step";

        const badge = document.createElement("div");
        badge.className = "badge";
        badge.textContent = String(idx+1);

        const label = document.createElement("input");
        label.type = "text";
        label.value = st.label;
        label.placeholder = "Step label (e.g., Breathe, Hold, Recover...)";
        label.addEventListener("input", () => {
          st.label = label.value;
          markSaved(false);
          saveAll();
        });

        const sec = document.createElement("input");
        sec.type = "number";
        sec.min = "1";
        sec.max = "3600";
        sec.value = String(st.sec);
        sec.className = "sec";
        sec.addEventListener("input", () => {
          st.sec = clamp(Math.floor(+sec.value || 1), 1, 3600);
          sec.value = String(st.sec);
          markSaved(false);
          saveAll();
        });

        const type = document.createElement("select");
        type.className = "type";
        ["rest","hold","custom"].forEach(t => {
          const opt = document.createElement("option");
          opt.value = t;
          opt.textContent = t.toUpperCase();
          if (st.type === t) opt.selected = true;
          type.appendChild(opt);
        });
        type.addEventListener("change", () => {
          st.type = type.value;
          markSaved(false);
          saveAll();
        });

        const actions = document.createElement("div");
        actions.className = "actions";

        const up = document.createElement("button");
        up.className = "tiny";
        up.textContent = "↑";
        up.title = "Move up";
        up.disabled = (idx === 0);
        up.addEventListener("click", () => {
          moveStep(idx, idx-1);
        });

        const down = document.createElement("button");
        down.className = "tiny";
        down.textContent = "↓";
        down.title = "Move down";
        down.disabled = (idx === routine.steps.length-1);
        down.addEventListener("click", () => {
          moveStep(idx, idx+1);
        });

        const del = document.createElement("button");
        del.className = "tiny danger";
        del.textContent = "Delete";
        del.addEventListener("click", () => {
          routine.steps.splice(idx,1);
          if (routine.steps.length === 0) routine.steps = defaultRoutine().steps;
          // keep timer stepIndex valid
          if (timer.stepIndex >= routine.steps.length) timer.stepIndex = routine.steps.length-1;
          markSaved(false);
          saveAll();
          if (!timer.running) syncUI();
        });

        actions.appendChild(up);
        actions.appendChild(down);
        actions.appendChild(del);

        // layout
        row.appendChild(label);
        row.appendChild(sec);
        row.appendChild(type);
        row.appendChild(actions);

        // On small screens, badge is less valuable; keep it subtle by prefixing label
        label.style.paddingLeft = "12px";
        label.style.position = "relative";
        label.style.backgroundImage = `linear-gradient(90deg, rgba(255,255,255,.08), rgba(255,255,255,0))`;
        label.style.backgroundSize = "0 0";
        label.insertAdjacentHTML("beforebegin", "");
        // Add badge as first child (desktop spacing)
        row.insertAdjacentElement("afterbegin", badge);

        box.appendChild(row);
      });
    }

    function moveStep(from, to){
      if (to < 0 || to >= routine.steps.length) return;
      const [x] = routine.steps.splice(from,1);
      routine.steps.splice(to,0,x);

      // adjust timer index if running so it tracks the same logical step
      if (timer.running){
        if (timer.stepIndex === from) timer.stepIndex = to;
        else if (from < timer.stepIndex && to >= timer.stepIndex) timer.stepIndex -= 1;
        else if (from > timer.stepIndex && to <= timer.stepIndex) timer.stepIndex += 1;
      }

      markSaved(false);
      saveAll();
      if (!timer.running) syncUI();
    }

    /***************
     * Timer core
     ***************/
    function setStatus(s){ $("status").textContent = s; }

    function currentStep(){
      if (!routine.steps.length) return null;
      return routine.steps[clamp(timer.stepIndex, 0, routine.steps.length-1)];
    }

    function resetTickClock(){
      timer.lastTick = performance.now();
      timer.accMs = 0;
    }

    function setStepIndex(i){
      if (!routine.steps.length) return;
      if (settings.loop){
        // wrap
        const n = routine.steps.length;
        timer.stepIndex = ((i % n) + n) % n;
      } else {
        timer.stepIndex = clamp(i, 0, routine.steps.length-1);
      }
      const st = currentStep();
      timer.remaining = st ? st.sec : 0;
      syncUI();
    }

    function stepSummary(){
      const st = currentStep();
      if (!st) return "No steps";
      return `${st.type.toUpperCase()} • ${st.label} • ${st.sec}s`;
    }

    function currentStepElapsed(){
      const st = currentStep();
      if (!st) return 0;
      return clamp(st.sec - timer.remaining, 0, st.sec);
    }

    function unlockSpeech(){
      if (speechUnlocked) return;
      if (!("speechSynthesis" in window) || typeof window.SpeechSynthesisUtterance !== "function") return;
      try{
        const u = new SpeechSynthesisUtterance(" ");
        u.volume = 0;
        window.speechSynthesis.speak(u);
        speechUnlocked = true;
      }catch(e){}
    }

    function speakCurrentStep(){
      if (!settings.voiceOn) return;
      if (!speechUnlocked) return;
      if (!("speechSynthesis" in window) || typeof window.SpeechSynthesisUtterance !== "function") return;
      const st = currentStep();
      if (!st) return;
      try{
        window.speechSynthesis.cancel();
        const spoken = String(st.label || "").replace(/(\d+)\s*s\b/gi, (m, n) => {
          const num = Number(n);
          return `${n} ${num === 1 ? "second" : "seconds"}`;
        });
        const u = new SpeechSynthesisUtterance(spoken);
        u.rate = 1;
        u.pitch = 1;
        u.volume = 1;
        window.speechSynthesis.speak(u);
      }catch(e){}
    }

    function onStepChange(reason){
      addLog(reason, stepSummary());
      speakCurrentStep();
      beep("phase");
    }

    function start(){
      if (timer.running) return;
      unlockSpeech();
      if (!routine.steps.length) routine.steps = defaultRoutine().steps;

      // bind routine loop/total to settings (you can override via JSON import too)
      routine.loop = settings.loop;
      routine.totalMin = settings.totalMin;

      if (settings.soundOn) ensureAudio();

      timer.running = true;
      timer.paused = false;
      timer.stepIndex = clamp(timer.stepIndex, 0, routine.steps.length-1);
      timer.elapsed = 0;
      timer.totalTarget = settings.loop ? (settings.totalMin * 60) : 0;

      const st = currentStep();
      timer.remaining = st ? st.sec : 0;

      timer.lastTick = performance.now();
      timer.accMs = 0;

      $("startBtn").disabled = true;
      $("pauseBtn").disabled = false;
      $("resumeBtn").disabled = true;
      $("stopBtn").disabled = false;
      $("prevBtn").disabled = false;
      $("nextBtn").disabled = false;
      $("restartStepBtn").disabled = false;

      setStatus("Running");
      addLog("Started", `${settings.loop ? "Loop" : "Run once"} • ${settings.loop ? `Total ${settings.totalMin}m` : "Stops at end"}`);
      beep("start");

      speakCurrentStep();
      syncUI();
      tick();
    }

    function pause(){
      if (!timer.running || timer.paused) return;
      timer.paused = true;
      setStatus("Paused");
      $("pauseBtn").disabled = true;
      $("resumeBtn").disabled = false;
      addLog("Paused");
      syncUI();
    }

    function resume(){
      if (!timer.running || !timer.paused) return;
      unlockSpeech();
      if (settings.soundOn) ensureAudio();
      timer.paused = false;
      timer.lastTick = performance.now();
      timer.accMs = 0;
      setStatus("Running");
      $("pauseBtn").disabled = false;
      $("resumeBtn").disabled = true;
      addLog("Resumed");
      speakCurrentStep();
      tick();
    }

    function stop(manual=true){
      if (!timer.running) return;
      timer.running = false;
      timer.paused = false;

      $("startBtn").disabled = false;
      $("pauseBtn").disabled = true;
      $("resumeBtn").disabled = true;
      $("stopBtn").disabled = true;
      $("prevBtn").disabled = true;
      $("nextBtn").disabled = true;
      $("restartStepBtn").disabled = true;

      setStatus("Stopped");
      if (manual){
        addLog("Stopped", `Elapsed ${fmtMMSS(timer.elapsed)}`);
        beep("end");
      }
      syncUI();
    }

    function nextStep(){
      if (!timer.running) return;
      const wasPaused = timer.paused;
      setStepIndex(timer.stepIndex + 1);
      onStepChange("Next");
    }

    function prevStep(){
      if (!timer.running) return;
      setStepIndex(timer.stepIndex - 1);
      onStepChange("Prev");
    }


    function restartStep(){
      if (!timer.running) return;
      const st = currentStep();
      timer.remaining = st ? st.sec : 0;
      onStepChange("Restart step");
      syncUI();
    }

    function advanceAuto(){
      // move to next; if run-once and we’re at end, stop.
      const atEnd = (timer.stepIndex === routine.steps.length - 1);
      if (!settings.loop && atEnd){
        stop(false);
        setStatus("Done");
        addLog("Completed", `Run-once finished • Elapsed ${fmtMMSS(timer.elapsed)}`);
        beep("end");
        return;
      }
      setStepIndex(timer.stepIndex + 1);
      onStepChange("Auto-advance");
    }

    function tick(){
      if (!timer.running || timer.paused) return;

      const now = performance.now();
      timer.accMs += (now - timer.lastTick);
      timer.lastTick = now;

      while (timer.accMs >= 1000){
        timer.accMs -= 1000;

        timer.elapsed += 1;
        timer.remaining -= 1;

        // total cap (loop mode)
        if (settings.loop && timer.elapsed >= timer.totalTarget){
          timer.running = false;
          timer.paused = false;

          $("startBtn").disabled = false;
          $("pauseBtn").disabled = true;
          $("resumeBtn").disabled = true;
          $("stopBtn").disabled = true;
          $("prevBtn").disabled = true;
          $("nextBtn").disabled = true;
          $("restartStepBtn").disabled = true;

          setStatus("Done");
          addLog("Completed", `Total ${fmtMMSS(timer.totalTarget)}`);
          beep("end");
          syncUI();
          return;
        }

        if (timer.remaining <= 0){
          advanceAuto();
        }
      }

      syncUI();
      requestAnimationFrame(tick);
    }

    /***************
     * UI sync
     ***************/
    function syncUI(){
      // settings UI
      $("loopMode").checked = settings.loop;
      $("totalMin").value = String(settings.totalMin);
      $("totalVal").textContent = fmtMSS(settings.totalMin * 60);
      $("soundOn").checked = settings.soundOn;
      $("voiceOn").checked = settings.voiceOn;
      $("volume").value = String(settings.volume);
      $("soundState").textContent = settings.soundOn ? "On" : "Off";
      $("voiceState").textContent = settings.voiceOn ? "On" : "Off";
      $("mode").textContent = settings.loop ? "Loop" : "Run once";

      // timer UI
      const st = currentStep();
      $("stepLabel").textContent = st ? st.label : "Ready";
      $("timeLeft").textContent = fmtMMSS(timer.running ? timer.remaining : 0);

      const totalLeft = settings.loop ? Math.max(0, timer.totalTarget - timer.elapsed) : 0;
      $("totalLeft").textContent = settings.loop ? fmtMMSS(totalLeft) : "--:--";
      $("elapsed").textContent = fmtMMSS(timer.elapsed);

      const n = routine.steps.length;
      const stepPos = timer.running ? (timer.stepIndex + 1) : 0;
      $("stepNum").textContent = `${stepPos}/${n}`;

      $("volVal").textContent = `${settings.volume}%`;

      // JSON box can show current routine if user wants
      // (we don’t overwrite while they’re typing unless they hit Export)
    }

    /***************
     * Import/export routine JSON
     ***************/
    function exportRoutine(){
      const obj = {
        name: routine.name || "Routine",
        loop: settings.loop,
        totalMin: settings.totalMin,
        steps: routine.steps.map(s => ({ label:s.label, sec:s.sec, type:s.type }))
      };
      $("jsonBox").value = JSON.stringify(obj, null, 2);
      addLog("Exported JSON", "Routine copied into the box");
    }

    function importRoutine(){
      const raw = $("jsonBox").value.trim();
      if (!raw) return;
      try{
        const obj = JSON.parse(raw);
        const sanitized = sanitizeRoutine(obj);

        // apply routine + also apply loop/total if present
        routine = sanitized;

        // if JSON includes loop/totalMin, use them as settings too
        if (obj.loop !== undefined) settings.loop = !!obj.loop;
        if (obj.totalMin !== undefined) settings.totalMin = clamp(+obj.totalMin || 8, 3, 300);

        // keep timer safe
        if (timer.stepIndex >= routine.steps.length) timer.stepIndex = 0;
        if (!timer.running){
          timer.remaining = routine.steps[0].sec;
        }

        renderSteps();
        saveAll();
        addLog("Imported JSON", `${routine.steps.length} steps`);
      }catch(e){
        alert("Invalid JSON. Make sure it’s a valid routine object with a steps array.");
      }
    }

    /***************
     * Wire controls
     ***************/
    function wire(){
      // settings
      $("loopMode").addEventListener("change", () => {
        settings.loop = $("loopMode").checked;
        markSaved(false);
        saveAll();
      });
      $("totalMin").addEventListener("input", () => {
        settings.totalMin = clamp(+$("totalMin").value, 3, 30);
        markSaved(false);
        saveAll();
      });
      $("soundOn").addEventListener("change", () => {
        settings.soundOn = $("soundOn").checked;
        markSaved(false);
        saveAll();
      });
      $("voiceOn").addEventListener("change", () => {
        settings.voiceOn = $("voiceOn").checked;
        if (!settings.voiceOn && ("speechSynthesis" in window)){
          try{ window.speechSynthesis.cancel(); }catch(e){}
        }
        markSaved(false);
        saveAll();
      });
      $("volume").addEventListener("input", () => {
        settings.volume = clamp(+$("volume").value, 0, 100);
        applyVolume();
        markSaved(false);
        saveAll();
      });

      // timer buttons
      $("startBtn").addEventListener("click", start);
      $("pauseBtn").addEventListener("click", pause);
      $("resumeBtn").addEventListener("click", resume);
      $("stopBtn").addEventListener("click", () => stop(true));
      $("nextBtn").addEventListener("click", nextStep);
      $("prevBtn").addEventListener("click", prevStep);
      $("restartStepBtn").addEventListener("click", restartStep);

      // editor actions
      $("addStepBtn").addEventListener("click", () => {
        routine.steps.push({ label:"New step", sec:30, type:"custom" });
        renderSteps();
        markSaved(false);
        saveAll();
      });

      $("addHoldRestBtn").addEventListener("click", () => {
        routine.steps.push({ label:"Breathe", sec:60, type:"rest" });
        routine.steps.push({ label:"Hold", sec:45, type:"hold" });
        renderSteps();
        markSaved(false);
        saveAll();
      });

      // json
      $("exportBtn").addEventListener("click", exportRoutine);
      $("importBtn").addEventListener("click", importRoutine);
      $("loadTendonBtn").addEventListener("click", () => {
        if (timer.running) return;
        const ok = confirm("Overwrite current steps with the Tendon Isometrics routine?");
        if (!ok) return;
        routine.steps = tendonRoutineSteps();
        // keep timer safe
        if (timer.stepIndex >= routine.steps.length) timer.stepIndex = 0;
        if (!timer.running){
          timer.remaining = routine.steps[0]?.sec || 0;
        }
        renderSteps();
        saveAll();
        addLog("Loaded Tendon Routine", `${routine.steps.length} steps`);
      });

      $("resetBtn").addEventListener("click", () => {
        if (timer.running) return;
        routine = defaultRoutine();
        settings.loop = false;
        settings.totalMin = 8;
        settings.soundOn = true;
        settings.voiceOn = true;
        settings.volume = 50;
        timer.stepIndex = 0;
        timer.remaining = routine.steps[0].sec;
        $("jsonBox").value = "";
        renderSteps();
        saveAll();
        addLog("Reset", "Defaults restored");
      });

      // keyboard shortcuts
      window.addEventListener("keydown", (e) => {
        const tag = (document.activeElement?.tagName || "").toLowerCase();
        const inField = (tag === "input" || tag === "textarea" || tag === "select");

        if (e.key === " " && !inField){
          e.preventDefault();
          if (!timer.running) start();
          else if (timer.running && !timer.paused) pause();
          else if (timer.running && timer.paused) resume();
        }

        if (!inField && (e.key === "n" || e.key === "N")){ if (timer.running) nextStep(); }
        if (!inField && (e.key === "p" || e.key === "P")){ if (timer.running) prevStep(); }
        if (!inField && (e.key === "s" || e.key === "S")){ if (timer.running) stop(true); }
      });
    }

    /***************
     * Init
     ***************/
    (function init(){
      loadAll();

      // reflect loaded settings into routine defaults (but keep routine steps)
      routine.loop = settings.loop;
      routine.totalMin = settings.totalMin;

      // initialize timer view
      timer.stepIndex = 0;
      timer.remaining = routine.steps[0]?.sec || 0;

      // paint UI
      renderSteps();
      loadLog();
      syncUI();

      // initial button states
      $("pauseBtn").disabled = true;
      $("resumeBtn").disabled = true;
      $("stopBtn").disabled = true;
      $("prevBtn").disabled = true;
      $("nextBtn").disabled = true;
      $("restartStepBtn").disabled = true;

      // status
      setStatus("Stopped");
      addLog("Ready", "Edit steps, then Start. Use Prev/Next anytime.");

      wire();
      saveAll();
    })();
  </script>
</body>
</html>
