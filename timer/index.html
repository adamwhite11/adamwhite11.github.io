<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CO₂ Tolerance Timer + Tendon Routine</title>
  <style>
    :root{
      --bg:#0b0f17;
      --text:#e8eefc;
      --muted:#a8b3cc;
      --accent:#6aa9ff;
      --accent2:#7cffc1;
      --warn:#ffcc66;
      --danger:#ff6a6a;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background: radial-gradient(1200px 800px at 20% -10%, rgba(106,169,255,.25), transparent 60%),
                  radial-gradient(900px 700px at 120% 10%, rgba(124,255,193,.18), transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    .wrap{max-width:980px;margin:0 auto;padding:18px 14px 40px}
    header{display:flex;gap:12px;align-items:flex-end;justify-content:space-between;flex-wrap:wrap;margin-bottom:14px}
    h1{margin:0;font-size:22px;letter-spacing:.2px}
    .subtitle{margin:2px 0 0;color:var(--muted);font-size:13px}

    .tabs{display:flex;gap:8px;align-items:center;background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.08);border-radius:999px;padding:6px}
    .tab{border:0;background:transparent;color:var(--muted);padding:10px 12px;border-radius:999px;cursor:pointer;font-weight:600;font-size:13px}
    .tab.active{background:rgba(106,169,255,.18);color:var(--text);border:1px solid rgba(106,169,255,.35)}

    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media (min-width:860px){.grid{grid-template-columns:1.1fr .9fr}}

    .card{background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.08);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden}
    .card .hd{padding:14px 14px 10px;display:flex;justify-content:space-between;align-items:center;gap:10px;
      border-bottom:1px solid rgba(255,255,255,.06);background:rgba(0,0,0,.12)}
    .card .hd h2{margin:0;font-size:14px;letter-spacing:.2px}
    .card .bd{padding:14px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .row > *{flex:1 1 auto}
    .muted{color:var(--muted);font-size:12px}
    .sep{height:10px}

    .big{font-variant-numeric:tabular-nums;font-size:54px;line-height:1;letter-spacing:.5px;margin:0}
    .phase{margin-top:6px;font-size:15px;color:var(--muted);letter-spacing:.2px}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.03);font-size:12px;color:var(--muted);white-space:nowrap}
    .pill b{color:var(--text);font-weight:700}

    .btnbar{display:flex;gap:10px;flex-wrap:wrap}
    button{
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      color:var(--text);
      padding:12px 14px;border-radius:14px;
      cursor:pointer;font-weight:700;letter-spacing:.2px;
      transition:transform .04s ease, background .15s ease, border-color .15s ease, opacity .15s ease;
      user-select:none;
    }
    button:active{transform:scale(.99)}
    button.primary{background:rgba(106,169,255,.22);border-color:rgba(106,169,255,.40)}
    button.good{background:rgba(124,255,193,.18);border-color:rgba(124,255,193,.35)}
    button.warn{background:rgba(255,204,102,.15);border-color:rgba(255,204,102,.35)}
    button.danger{background:rgba(255,106,106,.16);border-color:rgba(255,106,106,.35)}
    button:disabled{opacity:.45;cursor:not-allowed}
    .tinybtn{padding:9px 10px;border-radius:12px;font-size:12px;font-weight:800}

    .control{
      display:grid;
      grid-template-columns:1fr auto;
      gap:10px;align-items:center;
      padding:10px 12px;border-radius:14px;
      background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.08);
    }
    .control label{font-weight:700;font-size:13px}
    .control .val{font-variant-numeric:tabular-nums;font-weight:800;color:var(--text);min-width:120px;text-align:right}
    input[type="range"]{width:100%}
    input[type="checkbox"]{transform:scale(1.15)}
    textarea{
      width:100%;min-height:160px;padding:12px;border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.18);color:var(--text);
      font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono",monospace;
      font-size:12px;
    }

    .list{display:flex;flex-direction:column;gap:8px}
    .item{
      display:flex;justify-content:space-between;gap:10px;align-items:flex-start;
      padding:10px 12px;border-radius:14px;background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.08);
    }
    .item .name{font-weight:800;font-size:13px}
    .item .note{color:var(--muted);font-size:12px;margin-top:2px}
    .item .rt{color:var(--muted);font-size:12px;white-space:nowrap}
    .hidden{display:none !important;}
    .footerNote{margin-top:10px;color:var(--muted);font-size:12px;line-height:1.35}
    .hintBox{
      padding:10px 12px;border-radius:14px;
      background:rgba(124,255,193,.08);
      border:1px solid rgba(124,255,193,.20);
      color:var(--muted);font-size:12px;line-height:1.35
    }
    code.inline{font-family:ui-monospace,Menlo,Monaco,Consolas,monospace;font-size:12px;color:var(--text)}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>CO₂ Tolerance Timer</h1>
        <div class="subtitle">Now supports per-cycle arrays via JSON import.</div>
      </div>
      <div class="tabs" role="tablist" aria-label="Sections">
        <button class="tab active" id="tab-timer" role="tab" aria-selected="true">Timer</button>
        <button class="tab" id="tab-tendon" role="tab" aria-selected="false">Tendon Routine</button>
      </div>
    </header>

    <section id="view-timer">
      <div class="grid">
        <div class="card">
          <div class="hd">
            <h2>Session</h2>
            <span class="pill"><span>Cycle</span> <b id="cycle">0</b></span>
          </div>
          <div class="bd">
            <p class="big" id="phaseTime">00:00</p>
            <div class="phase" id="phaseLabel">Ready</div>

            <div class="sep"></div>
            <div class="row">
              <span class="pill"><span>Total left</span> <b id="totalLeft">00:00</b></span>
              <span class="pill"><span>Elapsed</span> <b id="elapsed">00:00</b></span>
              <span class="pill"><span>Status</span> <b id="status">Stopped</b></span>
            </div>

            <div class="sep"></div>
            <div class="row">
              <span class="pill"><span>Current hold</span> <b id="curHold">—</b></span>
              <span class="pill"><span>Current rest</span> <b id="curRest">—</b></span>
              <span class="pill"><span>Mode</span> <b id="mode">Single</b></span>
            </div>

            <div class="sep"></div>
            <div class="btnbar">
              <button class="primary" id="startBtn">Start</button>
              <button class="good" id="pauseBtn" disabled>Pause</button>
              <button class="good" id="resumeBtn" disabled>Resume</button>
              <button class="danger" id="stopBtn" disabled>Stop</button>
              <button class="tinybtn" id="resetSettingsBtn" title="Resets settings to defaults" style="margin-left:auto">Reset settings</button>
            </div>

            <div class="footerNote">
              Safety: do this seated. Stop if you feel unwell. Don’t do breath holds in water or while driving.
            </div>
          </div>
        </div>

        <div class="card">
          <div class="hd">
            <h2>Settings</h2>
            <span class="pill"><span>Saved</span> <b id="savedState">Yes</b></span>
          </div>
          <div class="bd">

            <div class="hintBox">
              JSON arrays: set <code class="inline">holdSec</code> and/or <code class="inline">restSec</code> to arrays.
              Example:<br>
              <code class="inline">"holdSec":[35,40,45], "restSec":[30,25,20]</code><br>
              The timer uses the next index each cycle and then holds at the last value.
            </div>

            <div class="sep"></div>

            <div class="control">
              <div>
                <label for="holdSec">Hold time (seconds)</label>
                <div class="muted">Slider controls single-value mode (JSON can override with arrays)</div>
              </div>
              <div class="val" id="holdVal">45s</div>
              <input id="holdSec" type="range" min="10" max="120" step="5" />
              <div></div>
            </div>

            <div class="sep"></div>

            <div class="control">
              <div>
                <label for="restSec">Breathe/rest time (seconds)</label>
                <div class="muted">Slider controls single-value mode (JSON can override with arrays)</div>
              </div>
              <div class="val" id="restVal">20s</div>
              <input id="restSec" type="range" min="5" max="90" step="5" />
              <div></div>
            </div>

            <div class="sep"></div>

            <div class="control">
              <div>
                <label for="totalMin">Total workout duration (minutes)</label>
              </div>
              <div class="val" id="totalVal">8:00</div>
              <input id="totalMin" type="range" min="3" max="20" step="1" />
              <div></div>
            </div>

            <div class="sep"></div>

            <div class="control">
              <div>
                <label>Hold cue</label>
                <div class="muted">Wording for the hold phase</div>
              </div>
              <div class="val">
                <label style="display:flex;gap:10px;align-items:center;justify-content:flex-end">
                  <input type="checkbox" id="holdOnInhale" />
                  <span style="font-weight:800">Hold on inhale</span>
                </label>
              </div>
            </div>

            <div class="sep"></div>

            <div class="control">
              <div>
                <label>Sound + vibration</label>
                <div class="muted">Sound requires user interaction (Start/Resume) on many phones</div>
              </div>
              <div class="val" style="display:flex;gap:10px;justify-content:flex-end;align-items:center">
                <label style="display:flex;gap:10px;align-items:center">
                  <input type="checkbox" id="soundOn" />
                  <span style="font-weight:800">Sound</span>
                </label>
                <label style="display:flex;gap:10px;align-items:center">
                  <input type="checkbox" id="vibeOn" />
                  <span style="font-weight:800">Vibe</span>
                </label>
              </div>
            </div>

            <div class="sep"></div>

            <div class="control">
              <div>
                <label for="volume">Volume</label>
                <div class="muted">Only used if Sound is on</div>
              </div>
              <div class="val" id="volVal">70%</div>
              <input id="volume" type="range" min="0" max="100" step="5" />
              <div></div>
            </div>

            <div class="sep"></div>

            <div class="row">
              <button class="tinybtn" id="copySettingsBtn">Copy settings JSON</button>
              <button class="tinybtn" id="loadSettingsBtn">Load JSON</button>
            </div>

            <div class="sep"></div>
            <textarea id="jsonBox" spellcheck="false" placeholder='Paste JSON here and tap "Load JSON".'></textarea>
          </div>
        </div>

        <div class="card" style="grid-column:1/-1">
          <div class="hd">
            <h2>Log</h2>
            <span class="pill"><span>Events</span> <b id="logCount">0</b></span>
          </div>
          <div class="bd">
            <div class="list" id="log"></div>
          </div>
        </div>
      </div>
    </section>

    <section id="view-tendon" class="hidden">
      <div class="grid">
        <div class="card" style="grid-column:1/-1">
          <div class="hd">
            <h2>Tendon Routine (editable)</h2>
            <span class="pill"><span>Editable</span> <b>Yes</b></span>
          </div>
          <div class="bd">
            <div class="muted" style="margin-bottom:10px">
              Simple checklist you can tweak anytime.
            </div>

            <div class="list" id="tendonList"></div>

            <div class="sep"></div>
            <div class="row">
              <button class="tinybtn" id="tendonAdd">Add item</button>
              <button class="tinybtn danger" id="tendonClear">Clear all</button>
              <button class="tinybtn" id="tendonCopy">Copy routine JSON</button>
              <button class="tinybtn" id="tendonLoad">Load JSON</button>
            </div>

            <div class="sep"></div>
            <textarea id="tendonJson" spellcheck="false" placeholder='Paste routine JSON here and tap "Load JSON".'></textarea>
          </div>
        </div>
      </div>
    </section>
  </div>

  <script>
    /***********************
     * Utilities
     ***********************/
    const $ = (id) => document.getElementById(id);
    const pad2 = (n) => String(n).padStart(2,'0');
    const clamp = (x,min,max) => Math.min(max, Math.max(min,x));
    function fmtMMSS(totalSec){
      totalSec = Math.max(0, Math.floor(totalSec));
      const m = Math.floor(totalSec/60);
      const s = totalSec%60;
      return `${pad2(m)}:${pad2(s)}`;
    }
    function fmtMSS(totalSec){
      totalSec = Math.max(0, Math.floor(totalSec));
      const m = Math.floor(totalSec/60);
      const s = totalSec%60;
      return `${m}:${pad2(s)}`;
    }
    function nowMs(){ return performance.now(); }

    /***********************
     * Defaults + storage
     ***********************/
    const DEFAULTS = {
      holdSec: 45,
      restSec: 20,
      totalMin: 8,
      holdOnInhale: true,
      soundOn: false,
      vibeOn: true,
      volume: 70
    };

    const STORAGE_KEY = "co2_timer_settings_v3";
    const TIMER_LOG_KEY = "co2_timer_log_v2";

    /***********************
     * Timer State
     ***********************/
    const timer = {
      running: false,
      paused: false,
      phase: "ready", // ready | prep | rest | hold | done
      cycle: 0,       // displayed cycle count starts at 1 when first rest begins
      totalTargetSec: 0,
      elapsedSec: 0,
      phaseRemainingSec: 0,

      // per-cycle schedule (Option 2)
      schedule: {
        mode: "single", // "single" | "array"
        holdList: null, // number[] or null
        restList: null, // number[] or null
        holdSingle: 0,
        restSingle: 0
      },

      // internal timekeeping
      lastTickMs: 0,
      accumMs: 0,

      // current phase plan
      phasePlan: null, // {name, durSec, kind}

      // audio
      audio: null
    };

    /***********************
     * Audio
     ***********************/
    function ensureAudio(){
      if (timer.audio) return timer.audio;
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const gain = ctx.createGain();
      gain.connect(ctx.destination);
      timer.audio = { ctx, gain };
      applyVolume();
      return timer.audio;
    }

    function applyVolume(){
      const vol = clamp(+$("volume").value, 0, 100) / 100;
      $("volVal").textContent = `${Math.round(vol*100)}%`;
      if (timer.audio) timer.audio.gain.gain.value = vol * 0.35;
    }

    function beep(pattern="short"){
      if (!$("soundOn").checked) return;
      const { ctx, gain } = ensureAudio();
      if (ctx.state === "suspended") ctx.resume().catch(()=>{});
      const t0 = ctx.currentTime;

      const seq = (pattern === "start") ? [0, .07, .14] :
                  (pattern === "phase") ? [0, .08] :
                  (pattern === "end") ? [0, .12, .24, .36] :
                  [0];

      seq.forEach(() => {
        const o = ctx.createOscillator();
        o.type = "sine";
        o.frequency.value = (pattern === "end") ? 880 : (pattern === "start" ? 740 : 660);
        o.connect(gain);
        const on = ctx.currentTime + seq.shift();
        const off = on + 0.10;
        try{ o.start(on); o.stop(off); }catch(e){}
      });
    }

    function vibrate(ms){
      if (!$("vibeOn").checked) return;
      if (!navigator.vibrate) return;
      try{ navigator.vibrate(ms); }catch(e){}
    }

    /***********************
     * Logging
     ***********************/
    function addLog(title, detail){
      const el = document.createElement("div");
      el.className = "item";
      const left = document.createElement("div");
      const right = document.createElement("div");
      right.className = "rt";

      const name = document.createElement("div");
      name.className = "name";
      name.textContent = title;

      const note = document.createElement("div");
      note.className = "note";
      note.textContent = detail || "";

      const ts = new Date();
      right.textContent = ts.toLocaleTimeString([], {hour:"2-digit", minute:"2-digit", second:"2-digit"});

      left.appendChild(name);
      if (detail) left.appendChild(note);
      el.appendChild(left);
      el.appendChild(right);

      const log = $("log");
      log.prepend(el);
      while (log.children.length > 50) log.removeChild(log.lastChild);
      $("logCount").textContent = String(log.children.length);
      saveLog();
    }

    function saveLog(){
      const items = Array.from($("log").children).map(x => {
        const name = x.querySelector(".name")?.textContent || "";
        const note = x.querySelector(".note")?.textContent || "";
        const rt = x.querySelector(".rt")?.textContent || "";
        return { name, note, rt };
      });
      localStorage.setItem(TIMER_LOG_KEY, JSON.stringify(items));
    }

    function loadLog(){
      try{
        const raw = localStorage.getItem(TIMER_LOG_KEY);
        if (!raw) return;
        const items = JSON.parse(raw);
        $("log").innerHTML = "";
        items.reverse().forEach(it => {
          const el = document.createElement("div");
          el.className = "item";
          const left = document.createElement("div");
          const right = document.createElement("div");
          right.className = "rt";
          right.textContent = it.rt || "";

          const name = document.createElement("div");
          name.className = "name";
          name.textContent = it.name || "";
          left.appendChild(name);

          if (it.note){
            const note = document.createElement("div");
            note.className = "note";
            note.textContent = it.note;
            left.appendChild(note);
          }

          el.appendChild(left);
          el.appendChild(right);
          $("log").prepend(el);
        });
        $("logCount").textContent = String($("log").children.length);
      }catch(e){}
    }

    /***********************
     * Settings load/save
     ***********************/
    function getSettings(){
      return {
        holdSec: +$("holdSec").value,
        restSec: +$("restSec").value,
        totalMin: +$("totalMin").value,
        holdOnInhale: $("holdOnInhale").checked,
        soundOn: $("soundOn").checked,
        vibeOn: $("vibeOn").checked,
        volume: +$("volume").value
      };
    }

    function setSettings(s){
      $("holdSec").value = clamp(s.holdSec ?? DEFAULTS.holdSec, 10, 120);
      $("restSec").value = clamp(s.restSec ?? DEFAULTS.restSec, 5, 90);
      $("totalMin").value = clamp(s.totalMin ?? DEFAULTS.totalMin, 3, 20);
      $("holdOnInhale").checked = !!(s.holdOnInhale ?? DEFAULTS.holdOnInhale);
      $("soundOn").checked = !!(s.soundOn ?? DEFAULTS.soundOn);
      $("vibeOn").checked = !!(s.vibeOn ?? DEFAULTS.vibeOn);
      $("volume").value = clamp(s.volume ?? DEFAULTS.volume, 0, 100);

      syncSettingLabels();
      applyVolume();
      markSaved(true);
    }

    function syncSettingLabels(){
      $("holdVal").textContent = `${+$("holdSec").value}s`;
      $("restVal").textContent = `${+$("restSec").value}s`;
      $("totalVal").textContent = fmtMSS((+$("totalMin").value)*60);
      $("volVal").textContent = `${+$("volume").value}%`;
    }

    function markSaved(isSaved){
      $("savedState").textContent = isSaved ? "Yes" : "No";
    }

    function saveSettings(){
      const s = getSettings();
      localStorage.setItem(STORAGE_KEY, JSON.stringify(s));
      markSaved(true);
    }

    function loadSettings(){
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return setSettings(DEFAULTS);
      try{
        const s = JSON.parse(raw);
        setSettings({ ...DEFAULTS, ...s });
      }catch(e){
        setSettings(DEFAULTS);
      }
    }

    /***********************
     * Option 2: schedule parsing
     ***********************/
    function normalizeNumArray(x){
      if (!Array.isArray(x)) return null;
      const out = x.map(v => Number(v)).filter(v => Number.isFinite(v) && v > 0);
      return out.length ? out : null;
    }

    function buildScheduleFromObject(obj){
      // obj can contain holdSec/restSec as number OR array
      const holdArr = normalizeNumArray(obj.holdSec);
      const restArr = normalizeNumArray(obj.restSec);

      const holdSingle = Number.isFinite(Number(obj.holdSec)) ? Number(obj.holdSec) : DEFAULTS.holdSec;
      const restSingle = Number.isFinite(Number(obj.restSec)) ? Number(obj.restSec) : DEFAULTS.restSec;

      const mode = (holdArr || restArr) ? "array" : "single";

      return {
        mode,
        holdList: holdArr,
        restList: restArr,
        holdSingle: clamp(holdSingle, 5, 600),
        restSingle: clamp(restSingle, 3, 600)
      };
    }

    function getHoldForCycle(cycleIndex0){
      // cycleIndex0: 0 for first hold/rest pair after prep
      if (timer.schedule.mode !== "array"){
        return timer.schedule.holdSingle;
      }
      const list = timer.schedule.holdList;
      if (!list || !list.length) return timer.schedule.holdSingle;
      const idx = Math.min(cycleIndex0, list.length - 1);
      return clamp(list[idx], 5, 600);
    }

    function getRestForCycle(cycleIndex0){
      if (timer.schedule.mode !== "array"){
        return timer.schedule.restSingle;
      }
      const list = timer.schedule.restList;
      if (!list || !list.length) return timer.schedule.restSingle;
      const idx = Math.min(cycleIndex0, list.length - 1);
      return clamp(list[idx], 3, 600);
    }

    /***********************
     * Timer Engine
     ***********************/
    function setStatus(text){ $("status").textContent = text; }

    function cueTextForHold(){
      return $("holdOnInhale").checked ? "Inhale, then HOLD" : "Exhale, then HOLD";
    }

    function setModeUI(){
      $("mode").textContent = (timer.schedule.mode === "array") ? "Array" : "Single";
    }

    function updateCurrentDurationsUI(){
      // For cycle display, we show the "current" cycle's values (based on cycle number shown)
      // cycle displayed starts at 1 when first rest begins, so cycleIndex0 = max(cycle-1,0)
      const idx0 = Math.max(timer.cycle - 1, 0);
      const h = getHoldForCycle(idx0);
      const r = getRestForCycle(idx0);
      $("curHold").textContent = `${h}s`;
      $("curRest").textContent = `${r}s`;
    }

    function nextPhasePlan(){
      // cycleIndex0: 0-based index for the schedule arrays
      const cycleIndex0 = Math.max(timer.cycle - 1, 0);

      if (timer.phase === "ready"){
        timer.phase = "prep";
        return { kind:"prep", name:"Get ready", durSec: 5 };
      }
      if (timer.phase === "prep"){
        timer.phase = "rest";
        timer.cycle = 1; // now we're in cycle 1
        const r = getRestForCycle(0);
        return { kind:"rest", name:"Breathe normally", durSec: r };
      }
      if (timer.phase === "rest"){
        timer.phase = "hold";
        const h = getHoldForCycle(cycleIndex0);
        return { kind:"hold", name: cueTextForHold(), durSec: h };
      }
      if (timer.phase === "hold"){
        timer.phase = "rest";
        timer.cycle += 1;
        const r = getRestForCycle(timer.cycle - 1); // because cycle increments first
        return { kind:"rest", name:"Breathe normally", durSec: r };
      }
      return null;
    }

    function updateUI(){
      $("cycle").textContent = String(timer.cycle);
      $("elapsed").textContent = fmtMMSS(timer.elapsedSec);
      $("totalLeft").textContent = fmtMMSS(Math.max(0, timer.totalTargetSec - timer.elapsedSec));
      $("phaseTime").textContent = fmtMMSS(timer.phaseRemainingSec);

      $("phaseLabel").textContent =
        (timer.phase === "hold") ? cueTextForHold() :
        (timer.phase === "rest") ? "Breathe normally" :
        (timer.phase === "prep") ? "Get ready" :
        (timer.phase === "done") ? "Done" : "Ready";

      setModeUI();
      updateCurrentDurationsUI();
    }

    function startSession(){
      if (timer.running) return;

      // schedule is based on CURRENT stored settings (single) unless JSON imported (array)
      const base = getSettings();
      timer.schedule = buildScheduleFromObject(base); // starts in single mode by default

      // If user pasted JSON in box and forgot to hit "Load", don't auto-load (too risky)
      // They must press Load JSON to enable arrays.

      if (base.soundOn) ensureAudio();

      timer.running = true;
      timer.paused = false;
      timer.phase = "ready";
      timer.cycle = 0;
      timer.elapsedSec = 0;
      timer.totalTargetSec = base.totalMin * 60;

      timer.phasePlan = nextPhasePlan();
      timer.phaseRemainingSec = timer.phasePlan?.durSec ?? 0;

      timer.lastTickMs = nowMs();
      timer.accumMs = 0;

      $("startBtn").disabled = true;
      $("pauseBtn").disabled = false;
      $("resumeBtn").disabled = true;
      $("stopBtn").disabled = false;

      setStatus("Running");
      addLog("Started", `${timer.schedule.mode === "array" ? "Array" : "Single"} mode • Total ${base.totalMin}m`);
      beep("start");
      vibrate(60);

      updateUI();
      tickLoop();
    }

    function pauseSession(){
      if (!timer.running || timer.paused) return;
      timer.paused = true;
      setStatus("Paused");
      $("pauseBtn").disabled = true;
      $("resumeBtn").disabled = false;
      addLog("Paused", "");
      vibrate(40);
      updateUI();
    }

    function resumeSession(){
      if (!timer.running || !timer.paused) return;
      if ($("soundOn").checked) ensureAudio();
      timer.paused = false;
      timer.lastTickMs = nowMs();
      timer.accumMs = 0;
      setStatus("Running");
      $("pauseBtn").disabled = false;
      $("resumeBtn").disabled = true;
      addLog("Resumed", "");
      vibrate(40);
      tickLoop();
    }

    function stopSession(manual=true){
      if (!timer.running) return;
      timer.running = false;
      timer.paused = false;
      timer.phase = "done";
      timer.phaseRemainingSec = 0;
      setStatus("Stopped");

      $("startBtn").disabled = false;
      $("pauseBtn").disabled = true;
      $("resumeBtn").disabled = true;
      $("stopBtn").disabled = true;

      if (manual){
        addLog("Stopped", `Elapsed ${fmtMMSS(timer.elapsedSec)}`);
        vibrate(120);
      }
      updateUI();
    }

    function advancePhase(){
      timer.phasePlan = nextPhasePlan();
      if (!timer.phasePlan){
        stopSession(false);
        return;
      }
      timer.phaseRemainingSec = timer.phasePlan.durSec;

      // log with per-cycle values when entering a hold/rest
      if (timer.phasePlan.kind === "rest" || timer.phasePlan.kind === "hold"){
        const idx0 = Math.max(timer.cycle - 1, 0);
        const h = getHoldForCycle(idx0);
        const r = getRestForCycle(idx0);
        const detail = `Cycle ${timer.cycle} • Hold ${h}s • Rest ${r}s`;
        addLog("Phase", `${timer.phasePlan.kind.toUpperCase()} • ${detail}`);
      } else {
        addLog("Phase", timer.phasePlan.name);
      }

      beep("phase");
      vibrate(70);
      updateUI();
    }

    function tickLoop(){
      if (!timer.running || timer.paused) return;

      const ms = nowMs();
      const dt = ms - timer.lastTickMs;
      timer.lastTickMs = ms;
      timer.accumMs += dt;

      while (timer.accumMs >= 1000){
        timer.accumMs -= 1000;

        timer.elapsedSec += 1;
        timer.phaseRemainingSec -= 1;

        if (timer.elapsedSec >= timer.totalTargetSec){
          timer.running = false;
          timer.phase = "done";
          timer.phaseRemainingSec = 0;

          $("startBtn").disabled = false;
          $("pauseBtn").disabled = true;
          $("resumeBtn").disabled = true;
          $("stopBtn").disabled = true;

          setStatus("Done");
          addLog("Completed", `Total ${fmtMMSS(timer.totalTargetSec)}`);
          vibrate(150);
          updateUI();
          return;
        }

        if (timer.phaseRemainingSec <= 0){
          advancePhase();
        } else {
          updateUI();
        }
      }

      requestAnimationFrame(tickLoop);
    }

    /***********************
     * Settings JSON import/export (now supports arrays)
     ***********************/
    function settingsToJson(){
      // export current sliders + toggles (single mode),
      // AND if schedule is array mode (because user imported), export arrays too.
      // We'll store imported arrays in timer.schedule ONLY during a session,
      // so exporting arrays is handled by the json box after load.
      const s = getSettings();
      return JSON.stringify(s, null, 2);
    }

    function applyLoadedObjectToUI(obj){
      // Apply toggles and totalMin if present
      if (obj.totalMin != null) $("totalMin").value = clamp(Number(obj.totalMin), 3, 20);
      if (obj.holdOnInhale != null) $("holdOnInhale").checked = !!obj.holdOnInhale;
      if (obj.soundOn != null) $("soundOn").checked = !!obj.soundOn;
      if (obj.vibeOn != null) $("vibeOn").checked = !!obj.vibeOn;
      if (obj.volume != null) $("volume").value = clamp(Number(obj.volume), 0, 100);

      // If holdSec/restSec are numbers, apply to sliders
      if (!Array.isArray(obj.holdSec) && obj.holdSec != null && Number.isFinite(Number(obj.holdSec))){
        $("holdSec").value = clamp(Number(obj.holdSec), 10, 120);
      }
      if (!Array.isArray(obj.restSec) && obj.restSec != null && Number.isFinite(Number(obj.restSec))){
        $("restSec").value = clamp(Number(obj.restSec), 5, 90);
      }

      syncSettingLabels();
      applyVolume();
    }

    function loadJsonIntoSettings(){
      const raw = $("jsonBox").value.trim();
      if (!raw) return;

      try{
        const obj = JSON.parse(raw);

        // Save "base" settings for toggles + slider numbers (so they persist)
        applyLoadedObjectToUI(obj);
        saveSettings();

        // Store array-mode presets in localStorage so the NEXT start can use them too.
        // We'll use a separate key so it doesn't break old saves.
        localStorage.setItem("co2_timer_arrays_v1", JSON.stringify({
          holdSec: Array.isArray(obj.holdSec) ? obj.holdSec : null,
          restSec: Array.isArray(obj.restSec) ? obj.restSec : null
        }));

        addLog("Settings loaded", `JSON (${(Array.isArray(obj.holdSec)||Array.isArray(obj.restSec)) ? "array" : "single"} mode)`);
        markSaved(true);
        updateUI();
      }catch(e){
        addLog("JSON error", "Could not parse settings JSON");
        alert("Could not parse JSON. Make sure it's a valid JSON object.");
      }
    }

    function loadArrayOverrides(){
      try{
        const raw = localStorage.getItem("co2_timer_arrays_v1");
        if (!raw) return null;
        const obj = JSON.parse(raw);
        const holdArr = Array.isArray(obj.holdSec) ? obj.holdSec : null;
        const restArr = Array.isArray(obj.restSec) ? obj.restSec : null;
        if (!holdArr && !restArr) return null;
        return { holdSec: holdArr, restSec: restArr };
      }catch(e){
        return null;
      }
    }

    async function copyText(text){
      try{ await navigator.clipboard.writeText(text); return true; }
      catch(e){ return false; }
    }

    /***********************
     * Tendon routine
     ***********************/
    const TENDON_KEY = "tendon_routine_v1";
    let tendon = [];

    function defaultTendon(){
      return [
        { name: "Doorway pec stretch", note: "60–90s", done: false },
        { name: "Straight-arm hang", note: "30–60s", done: false },
        { name: "Shoulder external rotation (band)", note: "2 x 12–20 slow", done: false },
        { name: "Wrist extensor isometrics", note: "4 x 30–45s each side", done: false },
        { name: "Calf isometrics", note: "4 x 30–45s", done: false }
      ];
    }
    function saveTendon(){ localStorage.setItem(TENDON_KEY, JSON.stringify(tendon)); }
    function loadTendon(){
      try{
        const raw = localStorage.getItem(TENDON_KEY);
        tendon = raw ? JSON.parse(raw) : defaultTendon();
      }catch(e){ tendon = defaultTendon(); }
      renderTendon();
    }

    function renderTendon(){
      const list = $("tendonList");
      list.innerHTML = "";
      tendon.forEach((it, idx) => {
        const row = document.createElement("div");
        row.className = "item";

        const left = document.createElement("div");
        const top = document.createElement("div");
        top.className = "name";
        top.style.display = "flex";
        top.style.alignItems = "center";
        top.style.gap = "10px";

        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.checked = !!it.done;
        cb.addEventListener("change", () => { it.done = cb.checked; saveTendon(); });

        const nameInput = document.createElement("input");
        nameInput.type = "text";
        nameInput.value = it.name || "";
        nameInput.style.width = "100%";
        nameInput.style.padding = "10px 10px";
        nameInput.style.borderRadius = "12px";
        nameInput.style.border = "1px solid rgba(255,255,255,.12)";
        nameInput.style.background = "rgba(0,0,0,.18)";
        nameInput.style.color = "var(--text)";
        nameInput.style.fontWeight = "800";
        nameInput.addEventListener("input", () => { it.name = nameInput.value; saveTendon(); });

        top.appendChild(cb);
        top.appendChild(nameInput);

        const noteInput = document.createElement("input");
        noteInput.type = "text";
        noteInput.value = it.note || "";
        noteInput.placeholder = "notes (sets/reps/time)";
        noteInput.style.marginTop = "8px";
        noteInput.style.width = "100%";
        noteInput.style.padding = "10px 10px";
        noteInput.style.borderRadius = "12px";
        noteInput.style.border = "1px solid rgba(255,255,255,.12)";
        noteInput.style.background = "rgba(0,0,0,.18)";
        noteInput.style.color = "var(--text)";
        noteInput.style.fontWeight = "700";
        noteInput.addEventListener("input", () => { it.note = noteInput.value; saveTendon(); });

        left.appendChild(top);
        left.appendChild(noteInput);

        const right = document.createElement("div");
        right.className = "rt";
        right.style.display = "flex";
        right.style.flexDirection = "column";
        right.style.gap = "8px";
        right.style.alignItems = "flex-end";

        const del = document.createElement("button");
        del.className = "tinybtn danger";
        del.textContent = "Delete";
        del.addEventListener("click", () => {
          tendon.splice(idx,1);
          saveTendon();
          renderTendon();
        });

        right.appendChild(del);
        row.appendChild(left);
        row.appendChild(right);
        list.appendChild(row);
      });

      $("tendonJson").value = JSON.stringify(tendon, null, 2);
    }

    function tendonLoadFromJson(){
      const raw = $("tendonJson").value.trim();
      if (!raw) return;
      try{
        const obj = JSON.parse(raw);
        if (!Array.isArray(obj)) throw new Error("Not an array");
        tendon = obj.map(x => ({ name: String(x.name ?? ""), note: String(x.note ?? ""), done: !!x.done }));
        saveTendon();
        renderTendon();
      }catch(e){
        alert("Could not parse routine JSON. It must be a JSON array.");
      }
    }

    /***********************
     * Tabs
     ***********************/
    function showTab(which){
      const isTimer = which === "timer";
      $("view-timer").classList.toggle("hidden", !isTimer);
      $("view-tendon").classList.toggle("hidden", isTimer);

      $("tab-timer").classList.toggle("active", isTimer);
      $("tab-tendon").classList.toggle("active", !isTimer);
      $("tab-timer").setAttribute("aria-selected", isTimer ? "true" : "false");
      $("tab-tendon").setAttribute("aria-selected", !isTimer ? "true" : "false");
    }

    /***********************
     * Wire up
     ***********************/
    function wire(){
      $("tab-timer").addEventListener("click", () => showTab("timer"));
      $("tab-tendon").addEventListener("click", () => showTab("tendon"));

      ["holdSec","restSec","totalMin","holdOnInhale","soundOn","vibeOn","volume"].forEach(id => {
        $(id).addEventListener("input", () => {
          syncSettingLabels();
          applyVolume();
          markSaved(false);
          saveSettings();
          updateUI();
        });
        $(id).addEventListener("change", () => {
          syncSettingLabels();
          applyVolume();
          markSaved(false);
          saveSettings();
          updateUI();
        });
      });

      $("startBtn").addEventListener("click", () => {
        // If user previously imported arrays, apply them to schedule automatically at start.
        // (This is the feature you want.)
        const base = getSettings();
        const overrides = loadArrayOverrides();
        const merged = { ...base, ...(overrides || {}) };
        timer.schedule = buildScheduleFromObject(merged);

        startSessionAfterScheduleSet(base.totalMin);
      });

      function startSessionAfterScheduleSet(totalMin){
        if (timer.running) return;
        const base = getSettings();

        if (base.soundOn) ensureAudio();

        timer.running = true;
        timer.paused = false;
        timer.phase = "ready";
        timer.cycle = 0;
        timer.elapsedSec = 0;
        timer.totalTargetSec = totalMin * 60;

        timer.phasePlan = nextPhasePlan();
        timer.phaseRemainingSec = timer.phasePlan?.durSec ?? 0;

        timer.lastTickMs = nowMs();
        timer.accumMs = 0;

        $("startBtn").disabled = true;
        $("pauseBtn").disabled = false;
        $("resumeBtn").disabled = true;
        $("stopBtn").disabled = false;

        setStatus("Running");
        addLog("Started", `${timer.schedule.mode === "array" ? "Array" : "Single"} mode • Total ${totalMin}m`);
        vibrate(60);
        updateUI();
        tickLoop();
      }

      $("pauseBtn").addEventListener("click", pauseSession);
      $("resumeBtn").addEventListener("click", resumeSession);
      $("stopBtn").addEventListener("click", () => stopSession(true));

      $("resetSettingsBtn").addEventListener("click", () => {
        if (timer.running) return;
        setSettings(DEFAULTS);
        localStorage.removeItem("co2_timer_arrays_v1");
        saveSettings();
        addLog("Settings reset", "Cleared array presets too");
        updateUI();
      });

      $("copySettingsBtn").addEventListener("click", async () => {
        const base = getSettings();
        const overrides = loadArrayOverrides();
        const obj = { ...base };
        if (overrides?.holdSec) obj.holdSec = overrides.holdSec;
        if (overrides?.restSec) obj.restSec = overrides.restSec;

        const text = JSON.stringify(obj, null, 2);
        $("jsonBox").value = text;

        const ok = await copyText(text);
        addLog("Settings copied", ok ? "Copied to clipboard" : "Copied to box (clipboard blocked)");
        if (!ok) alert("Copied into the box, but clipboard was blocked by the browser.");
      });

      $("loadSettingsBtn").addEventListener("click", loadJsonIntoSettings);

      $("tendonAdd").addEventListener("click", () => {
        tendon.unshift({ name: "New item", note: "", done: false });
        saveTendon();
        renderTendon();
      });
      $("tendonClear").addEventListener("click", () => { tendon = []; saveTendon(); renderTendon(); });
      $("tendonCopy").addEventListener("click", async () => {
        $("tendonJson").value = JSON.stringify(tendon, null, 2);
        const ok = await copyText($("tendonJson").value);
        if (!ok) alert("Clipboard blocked. JSON is in the box—copy it manually.");
      });
      $("tendonLoad").addEventListener("click", tendonLoadFromJson);

      // spacebar controls
      window.addEventListener("keydown", (e) => {
        if (e.key === " "){
          const tag = (document.activeElement?.tagName || "").toLowerCase();
          if (tag !== "input" && tag !== "textarea"){
            e.preventDefault();
            if (!timer.running) $("startBtn").click();
            else if (timer.running && !timer.paused) pauseSession();
            else if (timer.running && timer.paused) resumeSession();
          }
        }
        if (e.key.toLowerCase() === "s"){
          if (timer.running) stopSession(true);
        }
      });
    }

    /***********************
     * Init
     ***********************/
    (function init(){
      loadSettings();
      loadLog();
      loadTendon();
      syncSettingLabels();
      applyVolume();
      setStatus("Stopped");

      // show array vs single mode based on stored array presets
      const base = getSettings();
      const overrides = loadArrayOverrides();
      const merged = { ...base, ...(overrides || {}) };
      timer.schedule = buildScheduleFromObject(merged);

      updateUI();
      wire();
      addLog("Ready", `Mode: ${timer.schedule.mode === "array" ? "Array (from JSON import)" : "Single (sliders)"}`);
    })();
  </script>
</body>
</html>
